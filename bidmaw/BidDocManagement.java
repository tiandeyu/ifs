/*
*                 IFS Research & Development
*
*  This program is protected by copyright law and by international
*  conventions. All licensing, renting, lending or copying (including
*  for private use), and all other use of the program, which is not
*  expressively permitted by IFS Research & Development (IFS), is a
*  violation of the rights of IFS. Such violations will be reported to the
*  appropriate authorities.
*
*  VIOLATIONS OF ANY COPYRIGHT IS PUNISHABLE BY LAW AND CAN LEAD
*  TO UP TO TWO YEARS OF IMPRISONMENT AND LIABILITY TO PAY DAMAGES.
* ----------------------------------------------------------------------------
* File                          :
* Description                   :
* Notes                         :
* Other Programs Called :
* ----------------------------------------------------------------------------
* Modified    : Automatically generated by IFS/Design
* ----------------------------------------------------------------------------
*/

//-----------------------------------------------------------------------------
//-----------------------------   Package def  ------------------------------
//-----------------------------------------------------------------------------

package ifs.bidmaw;
//-----------------------------------------------------------------------------
//-----------------------------   Import def  ------------------------------
//-----------------------------------------------------------------------------

import ifs.fnd.asp.*;
import ifs.fnd.buffer.*;
import ifs.fnd.service.*;
import ifs.fnd.*;

//-----------------------------------------------------------------------------
//-----------------------------   Class def  ------------------------------
//-----------------------------------------------------------------------------

public class BidDocManagement extends ASPPageProvider
{

   //-----------------------------------------------------------------------------
   //---------- Static constants ------------------------------------------------
   //-----------------------------------------------------------------------------

   public static boolean DEBUG = Util.isDebugEnabled("ifs.bidmaw.BidDocMan");

   //-----------------------------------------------------------------------------
   //---------- Header Instances created on page creation --------
   //-----------------------------------------------------------------------------

   private ASPBlock headblk;
   private ASPRowSet headset;
   private ASPCommandBar headbar;
   private ASPTable headtbl;
   private ASPBlockLayout headlay;

   protected ASPTabContainer tabs;
   
   //-----------------------------------------------------------------------------
   //---------- Item Instances created on page creation --------
   //-----------------------------------------------------------------------------

   private ASPBlock bid_mat_list_blk;
   private ASPRowSet bid_mat_list_set;
   private ASPCommandBar bid_mat_list_bar;
   private ASPTable bid_mat_list_tbl;
   private ASPBlockLayout bid_mat_list_lay;

   private ASPBlock bid_proj_list_blk;
   private ASPRowSet bid_proj_list_set;
   private ASPCommandBar bid_proj_list_bar;
   private ASPTable bid_proj_list_tbl;
   private ASPBlockLayout bid_proj_list_lay;
   
   private String proj_no;
   private String plan_no;
   private String doc_id;


   //-----------------------------------------------------------------------------
   //------------------------  Construction  ---------------------------
   //-----------------------------------------------------------------------------

   public  BidDocManagement (ASPManager mgr, String page_path)
   {
      super(mgr,page_path);
   }

   public void run()
   {
      ASPManager mgr = getASPManager();

      if( mgr.commandBarActivated() )
         eval(mgr.commandBarFunction());
      else if(mgr.dataTransfered())
         okFind();
      else if("TRUE".equals(mgr.readValue("REFRESH_PARENT")))
      {
         headset.refreshRow();
         okFindITEM2();   
      }
      else if( !mgr.isEmpty(mgr.getQueryStringValue("SEARCH")) )
         okFind();
      else if( !mgr.isEmpty(mgr.getQueryStringValue("DOC_ID")) )
         okFind();
      else if( !mgr.isEmpty(mgr.getQueryStringValue("VALIDATE")) )
         validate();
      else
         okFind();
      tabs.saveActiveTab();
      
      adjust();
   }
   //-----------------------------------------------------------------------------
   //------------------------  Command Bar functions  ---------------------------
   //-----------------------------------------------------------------------------
   
   public void validate()
   {
       ASPManager mgr = getASPManager();
       ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
       ASPCommand cmd;
       String val = mgr.readValue("VALIDATE");    
       float tempValue = 0;
       String txt="";
       String matName="";
       String prodModel="";
       String budgetName="";
       String amount="";
       String unitCode="";
       String budgetName1="";
       String unitCode1="";
       String amount1="";
       String price1="";
       String creBidName="";
       String bidProjType="";
       
       
       if("ITEM1_PRICE".equals(val)){
          tempValue =((mgr.readValue("ITEM1_PRICE")==null)?0:Float.parseFloat(mgr.readValue("ITEM1_PRICE")))*
                      ((mgr.readValue("ITEM1_COUNT")==null)?0:Float.parseFloat(mgr.readValue("ITEM1_COUNT")));
       }
       else if("ITEM1_COUNT".equals(val)){
          tempValue =((mgr.readValue("ITEM1_PRICE")==null)?0:Float.parseFloat(mgr.readValue("ITEM1_PRICE")))*
                      ((mgr.readValue("ITEM1_COUNT")==null)?0:Float.parseFloat(mgr.readValue("ITEM1_COUNT")));
       }
       else if("CRE_ID".equals(val)){
          cmd = trans.addCustomFunction("GETCREATEBIDNAME", 
                "BID_CRE_PROJ_APPLY_API.GET_CREATE_BID_NAME", "CREATE_BID_NAME");
          cmd.addParameter("PROJ_NO,CRE_ID");
          
          cmd = trans.addCustomFunction("GETBIDPROJTYPE", 
                "BID_CRE_PROJ_APPLY_API.GET_BID_PROJ_TYPE", "BID_PROJ_TYPE");
          cmd.addParameter("PROJ_NO,CRE_ID");
          trans = mgr.validate(trans);
          
          creBidName = trans.getValue("GETCREATEBIDNAME/DATA/CREATE_BID_NAME");
          bidProjType = trans.getValue("GETBIDPROJTYPE/DATA/BID_PROJ_TYPE");
          
          txt = ((mgr.isEmpty(creBidName)) ? "" : creBidName) + "^" + 
          ((mgr.isEmpty(bidProjType)) ? "" : bidProjType) + "^";
    
          mgr.responseWrite(txt);
       }
       else if("MAT_NO".equals(val)){
          cmd = trans.addCustomFunction("GETMATNAME", 
                "MAT_CODE_API.GET_MAT_NAME", "MAT_NAME");
          cmd.addParameter("PROJ_NO,MAT_NO");
          
          cmd = trans.addCustomFunction("GETPRODMODEL", 
                "MAT_CODE_API.GET_PROD_MODEL", "PROD_MODEL");
          cmd.addParameter("PROJ_NO,MAT_NO");
          trans = mgr.validate(trans);
          
          matName = trans.getValue("GETMATNAME/DATA/MAT_NAME");
          prodModel = trans.getValue("GETPRODMODEL/DATA/PROD_MODEL");
          
          txt = ((mgr.isEmpty(matName)) ? "" : matName )+"^" + 
          ((mgr.isEmpty(prodModel)) ? "" : prodModel )+ "^";
    
          mgr.responseWrite(txt);
       }
       else if("BUDGET_LINE_NO".equals(val)){
          cmd = trans.addCustomFunction("GETBUDGETNAME", 
                "PROJECT_BUDGET_LINE_API.GET_BUDGET_NAME", "BUDGET_NAME");
          cmd.addParameter("PROJ_NO,BUDGET_LINE_NO");
          
          cmd = trans.addCustomFunction("GETAMOUNT", 
                "PROJECT_BUDGET_LINE_API.GET_AMOUNT", "AMOUNT");
          cmd.addParameter("PROJ_NO,BUDGET_LINE_NO");
          
          cmd = trans.addCustomFunction("GETUNITCODE", 
                "PROJECT_BUDGET_LINE_API.GET_UNIT_CODE", "UNIT_CODE");
          cmd.addParameter("PROJ_NO,BUDGET_LINE_NO");
          trans = mgr.validate(trans);
          
          budgetName = trans.getValue("GETBUDGETNAME/DATA/BUDGET_NAME");
          amount = trans.getValue("GETAMOUNT/DATA/AMOUNT");
          unitCode = trans.getValue("GETUNITCODE/DATA/UNIT_CODE");
          
          txt = ((mgr.isEmpty(budgetName)) ? "" : budgetName) + "^" + 
             ((mgr.isEmpty(amount)) ? "" : amount) + "^" +
          ((mgr.isEmpty(unitCode)) ? "" : unitCode) + "^";
    
          mgr.responseWrite(txt);
       }
       else if("ITEM1_BUDGET_LINE_NO".equals(val)){
          cmd = trans.addCustomFunction("GETITEM1BUDGETNAME", 
                "PROJECT_BUDGET_LINE_API.GET_BUDGET_NAME", "ITEM1_BUDGET_NAME");
          cmd.addParameter("PROJ_NO,ITEM1_BUDGET_LINE_NO");
          
          cmd = trans.addCustomFunction("GETITEM1AMOUNT", 
                "PROJECT_BUDGET_LINE_API.GET_AMOUNT", "ITEM1_AMOUNT");
          cmd.addParameter("PROJ_NO,ITEM1_BUDGET_LINE_NO");
          
          cmd = trans.addCustomFunction("GETITEM2PRICE", 
                "PROJECT_BUDGET_LINE_API.GET_PRICE", "ITEM2_PRICE");
          cmd.addParameter("PROJ_NO,ITEM1_BUDGET_LINE_NO");
          
          cmd = trans.addCustomFunction("GETITEM1UNITCODE", 
                "PROJECT_BUDGET_LINE_API.GET_UNIT_CODE", "ITEM1_UNIT_CODE");
          cmd.addParameter("PROJ_NO,ITEM1_BUDGET_LINE_NO");
          trans = mgr.validate(trans);
          
          budgetName1 = trans.getValue("GETITEM1BUDGETNAME/DATA/ITEM1_BUDGET_NAME");
          amount1 = trans.getValue("GETITEM1AMOUNT/DATA/ITEM1_AMOUNT");
          price1 = trans.getValue("GETITEM2PRICE/DATA/ITEM2_PRICE");
          unitCode1 = trans.getValue("GETITEM1UNITCODE/DATA/ITEM1_UNIT_CODE");
          
          txt = ((mgr.isEmpty(budgetName1)) ? "" : budgetName1) + "^" + 
             ((mgr.isEmpty(amount1)) ? "" : amount1) + "^" +
             ((mgr.isEmpty(price1)) ? "" : price1) + "^" +
          ((mgr.isEmpty(unitCode1)) ? "" : unitCode1) + "^";
    
          mgr.responseWrite(txt);
       }
      /* else if ("PRICE".equals(val)) {         
         tempValue = ((mgr.readValue("PRICE")==null)?0:Float.parseFloat(mgr.readValue("PRICE")))*
              ((mgr.readValue("COUNT")==null)?0:Float.parseFloat(mgr.readValue("COUNT")));
       }
       else if("COUNT".equals(val)){
          tempValue =((mgr.readValue("PRICE")==null)?0:Float.parseFloat(mgr.readValue("PRICE")))*
                      ((mgr.readValue("COUNT")==null)?0:Float.parseFloat(mgr.readValue("COUNT")));
       }
       
       mgr.responseWrite(String.valueOf(tempValue)+"^");*/
       mgr.endResponse();
   }
   
   public void okFind()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPQuery q;

      mgr.createSearchURL(headblk);
      q = trans.addQuery(headblk);
      q.includeMeta("ALL");
      if(mgr.dataTransfered())
         q.addOrCondition(mgr.getTransferedData());
      mgr.querySubmit(trans,headblk);
      if (  headset.countRows() == 0 )
      {
         mgr.showAlert("BIDDOCMANNODATA: No data found.");
         headset.clear();
      }
      eval( bid_mat_list_set.syncItemSets() );
      eval( bid_proj_list_set.syncItemSets() );
   }



   public void countFind()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPQuery q;

      q = trans.addQuery(headblk);
      q.setSelectList("to_char(count(*)) N");
      mgr.submit(trans);
      headlay.setCountValue(toInt(headset.getValue("N")));
      headset.clear();
   }



   public void newRow()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPBuffer data;
      ASPCommand cmd;

      cmd = trans.addEmptyCommand("HEAD","BID_DOC_MAN_API.New__",headblk);
      cmd.setOption("ACTION","PREPARE");
      trans = mgr.perform(trans);
      data = trans.getBuffer("HEAD/DATA");
      headset.addRow(data);
   }


   //-----------------------------------------------------------------------------
   //------------------------  Item block cmd bar functions  ---------------------------
   //-----------------------------------------------------------------------------


   public void okFindITEM1()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPQuery q;
      int headrowno;

      q = trans.addQuery(bid_mat_list_blk);
      q.addWhereCondition("PROJ_NO = ? AND PLAN_NO = ?");
//      q.addWhereCondition("PROJ_NO = ? AND PLAN_NO = ? AND DOC_ID = ?");
      q.addParameter("PROJ_NO", headset.getValue("PROJ_NO"));
      q.addParameter("PLAN_NO", headset.getValue("PLAN_NO"));
//      q.addParameter("DOC_ID", headset.getValue("DOC_ID"));
      q.includeMeta("ALL");
      headrowno = headset.getCurrentRowNo();
      mgr.querySubmit(trans,bid_mat_list_blk);
      headset.goTo(headrowno);
   }
   public void newRowITEM1()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPCommand cmd;
      ASPBuffer data;

      
      cmd = trans.addEmptyCommand("ITEM1","BID_MAT_LIST_API.New__",bid_mat_list_blk);
      cmd.setOption("ACTION","PREPARE");
      cmd.setParameter("ITEM0_PROJ_NO", headset.getValue("PROJ_NO"));
      cmd.setParameter("ITEM0_PLAN_NO", headset.getValue("PLAN_NO"));
      cmd.setParameter("ITEM0_DOC_ID", headset.getValue("DOC_ID"));
      trans = mgr.perform(trans);
      data = trans.getBuffer("ITEM1/DATA");
      bid_mat_list_set.addRow(data);
   }
   public void okFindITEM2()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPQuery q;
      int headrowno;

      q = trans.addQuery(bid_proj_list_blk);
      q.addWhereCondition("PROJ_NO = ? AND PLAN_NO = ? AND DOC_ID = ?");
      q.addParameter("PROJ_NO", headset.getValue("PROJ_NO"));
      q.addParameter("PLAN_NO", headset.getValue("PLAN_NO"));
      q.addParameter("DOC_ID", headset.getValue("DOC_ID"));
      q.addOrderByClause("BUDGE_LINE_NO");
      q.includeMeta("ALL");
      headrowno = headset.getCurrentRowNo();
      mgr.querySubmit(trans,bid_proj_list_blk);
      headset.goTo(headrowno);
   }
   public void newRowITEM2()
   {
      ASPManager mgr = getASPManager();
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      ASPCommand cmd;
      ASPBuffer data;

      
      cmd = trans.addEmptyCommand("ITEM2","BID_PROJ_LIST_API.New__",bid_proj_list_blk);
      cmd.setOption("ACTION","PREPARE");
      cmd.setParameter("ITEM1_PROJ_NO", headset.getValue("PROJ_NO"));
      cmd.setParameter("ITEM1_PLAN_NO", headset.getValue("PLAN_NO"));
      cmd.setParameter("ITEM1_DOC_ID", headset.getValue("DOC_ID"));
      trans = mgr.perform(trans);
      data = trans.getBuffer("ITEM2/DATA");
      bid_proj_list_set.addRow(data);
   }

   //-----------------------------------------------------------------------------
   //------------------------  Predefines Head ---------------------------
   //-----------------------------------------------------------------------------

   public void  preDefine()
   {
      ASPManager mgr = getASPManager();

      headblk = mgr.newASPBlock("MAIN");
      headblk.addField("OBJID").
              setHidden();
      headblk.addField("OBJVERSION").
              setHidden();
      
      headblk.addField("PROJ_NO").
              setMandatory().
              setInsertable().
              setDefaultNotVisible().
              setDynamicLOV("GENERAL_PROJECT").
              setLabel("BIDDOCMANPROJNO: Proj No").
              setSize(30);
      headblk.addField("GENERAL_PROJECT_PROJ_DESC").
              setFunction("GENERAL_PROJECT_API.GET_PROJ_DESC ( :PROJ_NO)").
              setLabel("BIDPLANGENERALPROJECTPROJDESC: General Project Proj Desc").
              setSize(30).
              setReadOnly();
      mgr.getASPField("PROJ_NO").setValidateFunction("GENERAL_PROJECT_PROJ_DESC");
      headblk.addField("CRE_ID").
              setInsertable().
              setDefaultNotVisible().
              setDynamicLOV("BID_CRE_PROJ_APPLY_LOV", "PROJ_NO").
              setLabel("BIDDOCMANCREID: Cre Id").
              setCustomValidation("PROJ_NO,CRE_ID", "CREATE_BID_NAME,BID_PROJ_TYPE").
              setSize(30);
      headblk.addField("CREATE_BID_NAME").
              setReadOnly().
              setFunction("BID_CRE_PROJ_APPLY_API.GET_CREATE_BID_NAME ( :PROJ_NO,:CRE_ID)").
              setLabel("BIDPLANLINECREATEBIDNAME: Create Bid Name").
              setSize(30);
      //通过立项序号带出项目类型来判断字表类型
      headblk.addField("BID_PROJ_TYPE").
              setFunction("BID_CRE_PROJ_APPLY_API.GET_BID_PROJ_TYPE (:PROJ_NO,:CRE_ID)").
//              setInsertable().
              setHidden().
              setLabel("BIDENQDOCMANBIDPROJTYPE: Bid Proj Type").
              setSize(30);
      
      headblk.addField("PLAN_NO").
              setMandatory().
              setInsertable().
              setDefaultNotVisible().
              setDynamicLOV("BID_PLAN").
              setLabel("BIDDOCMANPLANNO: Plan No").
              setSize(30);
      headblk.addField("PLAN_NAME").
              setReadOnly().
              setFunction("BID_PLAN_API.GET_PLAN_NAME ( :PROJ_NO,:PLAN_NO)").
              setLabel("BIDPLANLINEPLANNAME: Plan Name").
              setSize(30);
      mgr.getASPField("PLAN_NO").setValidation("PLAN_NAME");
      
      headblk.addField("CREATE_ORG").
              setInsertable().
              setDefaultNotVisible().
              setLabel("BIDDOCMANCREATEORG: Create Org").
              setSize(30).
              setDynamicLOV("GENERAL_ORGANIZATION");
      headblk.addField("START_ORG_NAME").
              setFunction("GENERAL_ORGANIZATION_API.Get_Org_Desc(:CREATE_ORG)").
              setLabel("CONPROJCONNECTIONLISTFREENOREPLYSTARTORGNAME: Start Org Name").
              setSize(30).
              setReadOnly();
      mgr.getASPField("CREATE_ORG").setValidation("START_ORG_NAME");

      headblk.addField("DOC_ID").
              setHidden().
              //setMandatory().
              setInsertable().
              setLabel("BIDDOCMANDOCID: Doc Id").
              setSize(30);
      headblk.addField("PLAN_DATE","Date").
              setInsertable().
              setDefaultNotVisible().
              setLabel("BIDDOCMANPLANDATE: Plan Date").
              setSize(30);
      headblk.addField("CREATE_DATE","Date").
              setInsertable().
              setDefaultNotVisible().
              setLabel("BIDDOCMANCREATEDATE: Create Date").
              setSize(30);
      headblk.addField("STATUS").
              setInsertable().
              setHidden().
              setLabel("BIDDOCMANSTATUS: Status").
              setSize(30);
     
      headblk.addField("DOC_TYPE").
              setInsertable().
              setHidden().
              setLabel("BIDDOCMANDOCTYPE: Doc Type").
              setSize(30);
     
      
      headblk.addField("BID_METHOD_NO").
              setInsertable().
              setDefaultNotVisible().
              setDynamicLOV("BID_METHOD").
              setLabel("BIDDOCMANBIDMETHODNO: Bid Method No").
              setSize(30);
      headblk.addField("DESCRIPTION").
              setReadOnly().
              setLabel("BIDMETHODDESCRIPTION: Description").
              setFunction("BID_METHOD_API.GET_DESCRIPTION (:BID_METHOD_NO)").
              setSize(30);
      mgr.getASPField("BID_METHOD_NO").setValidation("DESCRIPTION");
      headblk.addField("CREATE_PERSON").
              setReadOnly().
              setDefaultNotVisible().
              setLabel("BIDDOCMANCREATEPERSON: Create Person").
              setSize(30);
      headblk.addField("CREATE_PERSON_NAME").
              setFunction("PERSON_INFO_API.GET_NAME ( :CREATE_PERSON)").
              setLabel("BIDMATENQJUDGECREATEPERSONNAME: Create Person Name").
              setSize(30).
              setDefaultNotVisible().
              setReadOnly();
      headblk.addField("NOTE").
              setInsertable().
              setDefaultNotVisible().
              setLabel("BIDDOCMANNOTE: Note").
              setSize(129).
              setHeight(5);
     
      headblk.setView("BID_DOC_MAN");
      headblk.defineCommand("BID_DOC_MAN_API","New__,Modify__,Remove__");
      headset = headblk.getASPRowSet();
      headbar = mgr.newASPCommandBar(headblk);
      headtbl = mgr.newASPTable(headblk);
      headtbl.setTitle("BIDDOCMANTBLHEAD: Bid Doc Mans");
      headtbl.enableRowSelect();
      headtbl.setWrap();
      headlay = headblk.getASPBlockLayout();
      headlay.setDefaultLayoutMode(headlay.MULTIROW_LAYOUT);
      headlay.setDataSpan("NOTE", 5);
      headlay.setSimple("GENERAL_PROJECT_PROJ_DESC");
      headlay.setSimple("CREATE_BID_NAME");
      headlay.setSimple("PLAN_NAME");
      headlay.setSimple("CREATE_PERSON_NAME");
      headlay.setSimple("START_ORG_NAME");
      headlay.setSimple("DESCRIPTION");
      
      headbar.addCustomCommand("activateBidMatList", "Bid Mat List");
      headbar.addCustomCommand("activateBidProjList", "Bid Proj List");
      
      headbar.addCustomCommand("findBudgetLineNo",mgr.translate("FINDBUDGETLINENO: Find Budget Line No"));
     


      bid_mat_list_blk = mgr.newASPBlock("ITEM1");
      bid_mat_list_blk.addField("ITEM0_OBJID").
                       setHidden().
                       setDbName("OBJID");
      bid_mat_list_blk.addField("ITEM0_OBJVERSION").
                       setHidden().
                       setDbName("OBJVERSION");
      bid_mat_list_blk.addField("ITEM0_PROJ_NO").
                       setHidden().
                       setDbName("PROJ_NO").
                       setMandatory().
                       setInsertable().
                       setLabel("BIDMATLISTITEM0PROJNO: Proj No").
                       setSize(30);
      bid_mat_list_blk.addField("ITEM0_PLAN_NO").
                       setHidden().
                       setDbName("PLAN_NO").
                       setMandatory().
                       setInsertable().
                       setLabel("BIDMATLISTITEM0PLANNO: Plan No").
                       setSize(30);
      bid_mat_list_blk.addField("ITEM0_DOC_ID").
                       setHidden().
                       setDbName("DOC_ID").
                       setMandatory().
                       setInsertable().
                       setLabel("BIDMATLISTITEM0DOCID: Doc Id").
                       setSize(30);
      bid_mat_list_blk.addField("LINE_NO").
                       setHidden().
                       //setMandatory().
                       setInsertable().
                       setLabel("BIDMATLISTLINENO: Line No").
                       setSize(30);
      bid_mat_list_blk.addField("CONTRACT_SIGN_COUNT","Number").
                       setInsertable().
                       setHidden().
                       setLabel("BIDMATLISTCONTRACTSIGNCOUNT: Contract Sign Count").
                       setSize(30);
      bid_mat_list_blk.addField("CONTRACT_SIGN_AMOUNT","Number").
                       setInsertable().
                       setHidden().
                       setLabel("BIDMATLISTCONTRACTSIGNAMOUNT: Contract Sign Amount").
                       setSize(30);
      bid_mat_list_blk.addField("MAT_NO").
                       setInsertable().
                       setLabel("BIDMATLISTMATNO: Mat No").
                       setSize(30).
                       setCustomValidation("PROJ_NO,MAT_NO", "MAT_NAME,PROD_MODEL").
                       setDynamicLOV("MAT_CODE");
      bid_mat_list_blk.addField("MAT_NAME").
                       setFunction("MAT_CODE_API.GET_MAT_NAME (:PROJ_NO,:MAT_NO)").
                       setLabel("BIDMATLISTMATNAME: Mat Name").
                       setReadOnly().
                       setSize(30);
      bid_mat_list_blk.addField("PROD_MODEL").
                       setFunction("MAT_CODE_API.GET_MAT_NAME (:PROJ_NO,:MAT_NO)").
                       setLabel("BIDMATLISTPRODMODEL: Prod Model").
                       setReadOnly().
                       setSize(30);
      bid_mat_list_blk.addField("ITEM1_BUDGET_LINE_NO").
                       setDbName("BUDGET_LINE_NO").
                       setInsertable().
                       setDynamicLOV("PROJECT_BUDGET_LINE").
                       setLOVProperty("WHERE", "STATUS='1'").
                       setCustomValidation("PROJ_NO,ITEM1_BUDGET_LINE_NO", "ITEM1_BUDGET_NAME,ITEM1_AMOUNT,ITEM2_PRICE,ITEM1_UNIT_CODE").
                       setLabel("BIDMATLISTBUDGETLINENO: Budget Line No").
                       setSize(30);
      //概算编码带出以下字段
      bid_mat_list_blk.addField("ITEM1_BUDGET_NAME").
                       setLabel("BIDMATLISTBUDGETNAME: Budget Name").
                       setFunction("PROJECT_BUDGET_LINE_API.GET_BUDGET_NAME ( :PROJ_NO,:ITEM1_BUDGET_LINE_NO)").
                       setSize(30).
                       setReadOnly();
      bid_mat_list_blk.addField("ITEM1_AMOUNT").
                       setLabel("BIDMATLISTAMOUNT: Amount").
                       setFunction("PROJECT_BUDGET_LINE_API.GET_AMOUNT ( :PROJ_NO,:ITEM1_BUDGET_LINE_NO)").
                       setSize(30).
                       setReadOnly();
      bid_mat_list_blk.addField("ITEM2_PRICE").
                       setLabel("BIDMATLISTITEM2PRICE: Price").
                       setFunction("PROJECT_BUDGET_LINE_API.GET_PRICE ( :PROJ_NO,:ITEM1_BUDGET_LINE_NO)").
                       setSize(30).
                       setReadOnly();
      bid_mat_list_blk.addField("ITEM1_UNIT_CODE").
                       setLabel("BIDMATLISTUNITCODE: Unit Code").
                       setFunction("PROJECT_BUDGET_LINE_API.GET_UNIT_CODE ( :PROJ_NO,:ITEM1_BUDGET_LINE_NO)").
                       setSize(30).
                       setReadOnly();
      //end of above        
      //暂时隐藏，以后可能要用
      bid_mat_list_blk.addField("COUNT","Number").  
                       setInsertable().
                       setLabel("BIDMATLISTCOUNT: Count").
                       setSize(30);
      /*bid_mat_list_blk.addField("PRICE","Number").
                       setInsertable().
                       setHidden().
                       setLabel("BIDMATLISTPRICE: Price").
                       setCustomValidation("COUNT,PRICE","TOTAL_PRICE").
                       setSize(30);
      bid_mat_list_blk.addField("TOTAL_PRICE","Number").
                       setHidden().
                       setLabel("BIDMATLISTTOTALPRICE: Total Price").
                       setReadOnly(). 
                       setSize(30);*/
     
      bid_mat_list_blk.setView("BID_MAT_LIST");
      bid_mat_list_blk.defineCommand("BID_MAT_LIST_API","New__,Modify__,Remove__");
      bid_mat_list_blk.setMasterBlock(headblk);
      bid_mat_list_set = bid_mat_list_blk.getASPRowSet();
      bid_mat_list_bar = mgr.newASPCommandBar(bid_mat_list_blk);
      bid_mat_list_bar.defineCommand(bid_mat_list_bar.OKFIND, "okFindITEM1");
      bid_mat_list_bar.defineCommand(bid_mat_list_bar.NEWROW, "newRowITEM1");
      bid_mat_list_tbl = mgr.newASPTable(bid_mat_list_blk);
      bid_mat_list_tbl.setTitle("BIDMATLISTITEMHEAD1: BidMatList");
      bid_mat_list_tbl.enableRowSelect();
      bid_mat_list_tbl.setWrap();
      bid_mat_list_lay = bid_mat_list_blk.getASPBlockLayout();
      bid_mat_list_lay.setDefaultLayoutMode(bid_mat_list_lay.MULTIROW_LAYOUT);
      bid_mat_list_lay.setSimple("MAT_NAME");
      bid_mat_list_lay.setSimple("ITEM1_BUDGET_NAME");

      bid_proj_list_blk = mgr.newASPBlock("ITEM2");
      bid_proj_list_blk.addField("ITEM1_OBJID").
                        setHidden().
                        setDbName("OBJID");
      bid_proj_list_blk.addField("ITEM1_OBJVERSION").
                        setHidden().
                        setDbName("OBJVERSION");
      bid_proj_list_blk.addField("ITEM1_PROJ_NO").
                        setHidden().
                        setDbName("PROJ_NO").
                        setMandatory().
                        setInsertable().
                        setLabel("BIDPROJLISTITEM1PROJNO: Proj No").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_PLAN_NO").
                        setHidden().
                        setDbName("PLAN_NO").
                        setMandatory().
                        setInsertable().
                        setLabel("BIDPROJLISTITEM1PLANNO: Plan No").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_DOC_ID").
                        setHidden().
                        setDbName("DOC_ID").
                        setMandatory().
                        setInsertable().
                        setLabel("BIDPROJLISTITEM1DOCID: Doc Id").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_LINE_NO").
                        setHidden().
                        setDbName("LINE_NO").
                       // setMandatory().
                        setInsertable().
                        setLabel("BIDPROJLISTITEM1LINENO: Line No").
                        setSize(30);
      bid_proj_list_blk.addField("BUDGET_LINE_NO").
                        setDbName("BUDGE_LINE_NO").
                        setInsertable().
                        setLabel("BIDPROJLISTBUDGELINENO: Budge Line No").
                        setSize(30).
                        setCustomValidation("PROJ_NO,BUDGET_LINE_NO", "BUDGET_NAME,AMOUNT,UNIT_CODE").
                        setDynamicLOV("PROJECT_BUDGET_LINE");
      bid_proj_list_blk.addField("BUDGET_NAME").
                        setReadOnly().
                        setFunction("PROJECT_BUDGET_LINE_API.Get_Budget_Name (:PROJ_NO,:BUDGET_LINE_NO)").
                        setLabel("BIDPROJLISTBUDGETNAME: Budget Name").
                        setSize(30);
      /*bid_proj_list_blk.addField("编制依据").
                        setReadOnly().
                        setFunction("PROJECT_BUDGET_LINE_API.Get_编制依据 (:PROJ_NO,:BUDGET_LINE_NO)").
                        setLabel("BIDPROJLIST编制依据: 编制依据").
                        setSize(30);*/
      bid_proj_list_blk.addField("AMOUNT").
                        setReadOnly().
                        setFunction("PROJECT_BUDGET_LINE_API.Get_AMOUNT (:PROJ_NO,:BUDGET_LINE_NO)").
                        setLabel("BIDPROJLISTAMOUNT: Amount").
                        setSize(30);
      bid_proj_list_blk.addField("UNIT_CODE").
                        setReadOnly().
                        setFunction("PROJECT_BUDGET_LINE_API.Get_UNIT_CODE (:PROJ_NO,:BUDGET_LINE_NO)").
                        setLabel("BIDPROJLISTUNITCODE: Unit Code").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_CONTRACT_SIGN_COUNT").
                        setDbName("CONTRACT_SIGN_COUNT").
                        setInsertable().
                        setHidden().
                        setLabel("BIDPROJLISTITEM1CONTRACTSIGNCOUNT: Contract Sign Count").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_CONTRACT_SIGN_AMOUNT").
                        setDbName("CONTRACT_SIGN_AMOUNT").
                        setInsertable().
                        setHidden().
                        setLabel("BIDPROJLISTITEM1CONTRACTSIGNAMOUNT: Contract Sign Amount").
                        setSize(30);
      bid_proj_list_blk.addField("FEE_NAME").
                        setInsertable().
                        setLabel("BIDPROJLISTFEENAME: Fee Name").
                        setSize(30);
      bid_proj_list_blk.addField("PROJ_FEATURE").
                        setInsertable().
                        setLabel("BIDPROJLISTPROJFEATURE: Proj Feature").
                        setSize(30);
      bid_proj_list_blk.addField("DOC_DESC").
                        setInsertable().
                        setLabel("BIDPROJLISTDOCDESC: Doc Desc").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_COUNT","Number").
                        setDbName("COUNT").
                        setInsertable().
                        setHidden().
                        setCustomValidation("ITEM1_COUNT,ITEM1_PRICE","ITEM1_TOTAL_PRICE").
                        setLabel("BIDPROJLISTITEM1COUNT: Count").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_PRICE","Number").
                        setDbName("PRICE").
                        setInsertable().
                        setHidden().
                        setCustomValidation("ITEM1_COUNT,ITEM1_PRICE","ITEM1_TOTAL_PRICE").
                        setLabel("BIDPROJLISTITEM1PRICE: Price").
                        setSize(30);
      bid_proj_list_blk.addField("ITEM1_TOTAL_PRICE","Number").
                        setDbName("TOTAL_PRICE").
                        setHidden().
                        setLabel("BIDPROJLISTITEM1TOTALPRICE: Total Price").
                        setReadOnly().
                        setSize(30);
      
      bid_proj_list_blk.setView("BID_PROJ_LIST");
      bid_proj_list_blk.defineCommand("BID_PROJ_LIST_API","New__,Modify__,Remove__");
      bid_proj_list_blk.setMasterBlock(headblk);
      bid_proj_list_set = bid_proj_list_blk.getASPRowSet();
      bid_proj_list_bar = mgr.newASPCommandBar(bid_proj_list_blk);
      bid_proj_list_bar.defineCommand(bid_proj_list_bar.OKFIND, "okFindITEM2");
      bid_proj_list_bar.defineCommand(bid_proj_list_bar.NEWROW, "newRowITEM2");
      bid_proj_list_tbl = mgr.newASPTable(bid_proj_list_blk);
      bid_proj_list_tbl.setTitle("BIDPROJLISTITEMHEAD2: BidProjList");
      bid_proj_list_tbl.enableRowSelect();
      bid_proj_list_tbl.setWrap();
      bid_proj_list_lay = bid_proj_list_blk.getASPBlockLayout();
      bid_proj_list_lay.setDefaultLayoutMode(bid_proj_list_lay.MULTIROW_LAYOUT);
      bid_proj_list_lay.setSimple("BUDGET_NAME");
      //tabs
      tabs=mgr.newASPTabContainer();
      tabs.addTab(mgr.translate("BIDMATLIST: Bid Mat List"),"javascript:commandSet('MAIN.activateBidMatList','')");
      tabs.addTab(mgr.translate("BIDPROJLIST: Bid Proj List"), "javascript:commandSet('MAIN.activateBidProjList','')");
   }

   //跳转查找插入页面
   public void findBudgetLineNo() throws FndException{
      //TODO
      ASPManager mgr = getASPManager();
      ASPCommand cmd = mgr.newASPCommand(); 
      ASPTransactionBuffer trans = mgr.newASPTransactionBuffer();
      headset.storeSelections();  
      if (headlay.isSingleLayout())
         headset.selectRow();
      ASPBuffer selected_fields=headset.getSelectedRows("PROJ_NO,PLAN_NO,DOC_ID");
      proj_no = headset.getValue("PROJ_NO");
      plan_no = headset.getValue("PLAN_NO");  
      doc_id = headset.getValue("DOC_ID");
      callNewWindow("BudgetLineNoFind.page", selected_fields);
   }
   
   private void callNewWindow(String transfer_page, ASPBuffer buff) throws FndException 
   {
       String id;
       ASPManager mgr = getASPManager();

        ASPContext ctx = mgr.getASPContext();
        ctx.setGlobal("PROJ_NO",proj_no);
        ctx.setGlobal("PLAN_NO",plan_no);
        ctx.setGlobal("DOC_ID",doc_id);
        proj_no=buff.getBufferAt(0).getValueAt(0);
        plan_no=buff.getBufferAt(0).getValueAt(1);
        doc_id=buff.getBufferAt(0).getValueAt(2);

      String url = transfer_page+"?PROJ_NO="+proj_no+"&PLAN_NO="+plan_no+"&DOC_ID="+doc_id;
      appendDirtyJavaScript("showNewBrowser_('"+ url + "', 550, 550, 'YES'); \n");
   }
   //end

   public void  adjust()
   {
      // fill function body
      ASPManager mgr = getASPManager();
      String projType;
      if(headset.countRows()>0){
         projType = (headset.getValue("BID_PROJ_TYPE")==null||"".equals(headset.getValue("BID_PROJ_TYPE"))) ? "": headset.getValue("BID_PROJ_TYPE");
         if(projType.equals("物资类")){
            tabs.setTabRemoved(2, true);
         }else{
            tabs.setTabRemoved(1, true);
         }
      }
      headbar.removeCustomCommand("activateBidMatList");
      headbar.removeCustomCommand("activateBidProjList");
   }

   //-----------------------------------------------------------------------------
   //------------------------  Presentation functions  ---------------------------
   //-----------------------------------------------------------------------------
   
  
   public void activateBidMatList(){
      tabs.setActiveTab(1);
      okFindITEM1();
   }
   public void activateBidProjList(){
      tabs.setActiveTab(2);
      okFindITEM2();
   }
   

   protected String getDescription()
   {
      return "BIDDOCMANDESC: Bid Doc Man";
   }


   protected String getTitle()
   {
      return "BIDDOCMANTITLE: Bid Doc Man";
   }


   protected void printContents() throws FndException
   {
      ASPManager mgr = getASPManager();
      printHiddenField("REFRESH_PARENT", "FALSE");
      if (headlay.isVisible())
          appendToHTML(headlay.show());
//      if (bid_mat_list_lay.isVisible())
//          appendToHTML(bid_mat_list_lay.show());
//      if (bid_proj_list_lay.isVisible())
//          appendToHTML(bid_proj_list_lay.show());
      else 
      {
         headlay.setLayoutMode(headlay.CUSTOM_LAYOUT);
         appendToHTML(headlay.show());
      }  
      
      if (headset.countRows()>0)
      {
         if (headlay.isSingleLayout()||headlay.isCustomLayout() ||headlay.isEditLayout())
         {
            appendToHTML(tabs.showTabsInit());
            if (tabs.getActiveTab()== 1)
            {
               appendToHTML(bid_mat_list_lay.show());
            }else if(tabs.getActiveTab()== 2){
               appendToHTML(bid_proj_list_lay.show());
            }     
            appendToHTML(tabs.showTabsFinish());
            
          } 
      }
        
      appendDirtyJavaScript("function refreshParent()\n");
      appendDirtyJavaScript("{\n");
      appendDirtyJavaScript(" document.form.REFRESH_PARENT.value=\"TRUE\"\n");
      appendDirtyJavaScript(" submit() \n");
      appendDirtyJavaScript("}\n");
      
   }
   
   
}
